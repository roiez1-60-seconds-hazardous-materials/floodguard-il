<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FloodGuard IL â€” ××¢×¨×›×ª ×”×ª×¨×¢×” ×œ×”×¦×¤×•×ª</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
@import url('https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;800&display=swap');
:root{--bg:#f0f2f5;--bg2:#ffffff;--card:#ffffff;--brd:#d1d5db;--tx:#1a1a2e;--tx2:#6b7280;--ac:#2563eb;--ok:#16a34a;--wr:#d97706;--dn:#dc2626;--cr:#b91c1c;--shadow:0 1px 3px rgba(0,0,0,.1)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Heebo',sans-serif;background:var(--bg);color:var(--tx);height:100vh;overflow:hidden}
#header{background:var(--bg2);border-bottom:1px solid var(--brd);padding:8px 16px;display:flex;align-items:center;justify-content:space-between;height:48px;box-shadow:var(--shadow)}
.brand{font-size:17px;display:flex;align-items:center;gap:8px}
.brand span{color:var(--ac)}
.status{display:flex;align-items:center;gap:10px;font-size:12px;color:var(--tx2)}
.pulse-dot{width:8px;height:8px;border-radius:50%;background:var(--ok);animation:p 2s infinite}
@keyframes p{50%{opacity:.3}}
#app{display:flex;height:calc(100vh - 48px)}
#mapWrap{flex:1;position:relative}
#map{width:100%;height:100%}
#sidebar{width:320px;background:var(--bg2);border-right:1px solid var(--brd);display:flex;flex-direction:column;box-shadow:-2px 0 6px rgba(0,0,0,.06)}
#mapBtns{position:absolute;top:10px;left:10px;z-index:500;display:flex;flex-direction:column;gap:6px}
#mapBtns button{background:var(--bg2);border:1px solid var(--brd);border-radius:8px;padding:7px 12px;color:var(--tx);font-family:inherit;font-size:12px;cursor:pointer;transition:.2s;box-shadow:var(--shadow)}
#mapBtns button:hover{border-color:var(--ac);background:#eff6ff}
#mapBtns button.on{background:#2563eb;border-color:#2563eb;color:#fff}
#legend{position:absolute;bottom:16px;left:16px;z-index:500;background:var(--bg2);border:1px solid var(--brd);border-radius:8px;padding:10px;font-size:11px;line-height:1.8;box-shadow:var(--shadow)}
#legend b{display:block;margin-bottom:4px;color:var(--tx2)}
.dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-left:6px;vertical-align:middle}
#tabs{display:flex;border-bottom:1px solid var(--brd)}
.tab{flex:1;padding:10px;text-align:center;font-size:12px;font-weight:600;color:var(--tx2);cursor:pointer;border:none;border-bottom:2px solid transparent;background:none;font-family:inherit}
.tab.on{color:var(--ac);border-bottom-color:var(--ac)}
.tab:hover{color:var(--tx)}
#panel{flex:1;overflow-y:auto;padding:10px;background:var(--bg)}
#panel::-webkit-scrollbar{width:4px}
#panel::-webkit-scrollbar-thumb{background:var(--brd);border-radius:2px}
.pane{display:none}
.pane.on{display:block}
#counters{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:10px}
.cnt{text-align:center;padding:8px;border-radius:8px;background:var(--card);border:1px solid var(--brd);box-shadow:var(--shadow)}
.cnt-n{font-size:24px;font-weight:800}
.cnt-l{font-size:10px;color:var(--tx2)}
.cw .cnt-n{color:var(--wr)}
.cd .cnt-n{color:var(--dn)}
.ce .cnt-n{color:var(--cr)}
.card{background:var(--card);border:1px solid var(--brd);border-radius:8px;padding:10px;margin-bottom:6px;cursor:pointer;transition:.15s;box-shadow:var(--shadow)}
.card:hover{border-color:var(--ac);transform:translateX(-2px)}
.card.lv-m{border-right:3px solid var(--wr)}
.card.lv-h{border-right:3px solid var(--dn)}
.card.lv-e{border-right:3px solid var(--cr)}
.card-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.card-name{font-size:13px;font-weight:600}
.card-badge{font-size:10px;padding:2px 7px;border-radius:8px;font-weight:600}
.bg-s{background:rgba(22,163,74,.1);color:var(--ok)}
.bg-m{background:rgba(217,119,6,.1);color:var(--wr)}
.bg-h{background:rgba(220,38,38,.1);color:var(--dn)}
.bg-e{background:rgba(185,28,28,.12);color:var(--cr)}
.card-info{font-size:11px;color:var(--tx2);display:flex;gap:10px}
#search{width:100%;padding:8px 10px;background:var(--card);border:1px solid var(--brd);border-radius:8px;color:var(--tx);font-family:inherit;font-size:13px;outline:none;margin-bottom:8px}
#search:focus{border-color:var(--ac);box-shadow:0 0 0 2px rgba(37,99,235,.15)}
#dropZone{background:var(--card);border:2px dashed var(--brd);border-radius:8px;padding:20px;text-align:center;cursor:pointer;font-size:13px;margin-top:8px;transition:.2s}
#dropZone:hover{border-color:var(--ac);background:#eff6ff}
.hint{font-size:12px;color:var(--tx2);text-align:center;padding:16px;line-height:1.6}
.srcBtn{background:var(--card);color:var(--tx2);border:1px solid var(--brd);border-radius:6px;padding:4px 10px;font-size:11px;cursor:pointer;flex:1;font-family:inherit}
.srcBtn.on{background:var(--ac);color:#fff;border-color:var(--ac)}
#radarTime{background:var(--bg2)!important;box-shadow:var(--shadow)}
@media(max-width:768px){
  #app{flex-direction:column}
  #sidebar{width:100%;height:45vh;border-right:none;border-top:1px solid var(--brd)}
  #mapWrap{height:55vh}
}
/* Dark mode â€” auto by time or prefers-color-scheme */
@media(prefers-color-scheme:dark){
  :root{--bg:#111827;--bg2:#1f2937;--card:#1f2937;--brd:#374151;--tx:#f3f4f6;--tx2:#9ca3af;--ac:#3b82f6;--shadow:0 1px 3px rgba(0,0,0,.3)}
  #mapBtns button{background:#1f2937;color:#f3f4f6;border-color:#374151}
  #mapBtns button:hover{background:#374151}
  #mapBtns button.on{background:#2563eb;color:#fff}
  #legend{background:#1f2937}
  #search{background:#1f2937;color:#f3f4f6;border-color:#374151}
  #dropZone{background:#1f2937;border-color:#374151}
  .srcBtn{background:#1f2937;color:#9ca3af;border-color:#374151}
  .srcBtn.on{background:#2563eb;color:#fff}
}
body.dark{--bg:#111827;--bg2:#1f2937;--card:#1f2937;--brd:#374151;--tx:#f3f4f6;--tx2:#9ca3af;--ac:#3b82f6;--shadow:0 1px 3px rgba(0,0,0,.3)}
body.dark #mapBtns button{background:#1f2937;color:#f3f4f6;border-color:#374151}
body.dark #mapBtns button:hover{background:#374151}
body.dark #mapBtns button.on{background:#2563eb;color:#fff}
body.dark #legend{background:#1f2937}
body.dark #search{background:#1f2937;color:#f3f4f6;border-color:#374151}
body.dark #dropZone{background:#1f2937;border-color:#374151}
body.dark .srcBtn{background:#1f2937;color:#9ca3af;border-color:#374151}
body.dark .srcBtn.on{background:#2563eb;color:#fff}
/* Animation player bar */
#animBar{position:absolute;bottom:10px;right:10px;left:220px;z-index:500;background:var(--card);border:1px solid var(--brd);border-radius:8px;padding:6px 10px;display:none;align-items:center;gap:8px;box-shadow:var(--shadow);font-size:11px}
#animBar button{background:none;border:none;font-size:16px;cursor:pointer;padding:2px 4px}
#animSlider{flex:1;height:4px;cursor:pointer;accent-color:var(--ac)}
#animTime{color:var(--tx2);min-width:50px;text-align:center}
/* Share button in cards */
.share-btn{background:none;border:none;font-size:13px;cursor:pointer;padding:2px;opacity:.6;transition:.2s}
.share-btn:hover{opacity:1}
/* Layer controls */
#layerBtns{position:absolute;top:10px;right:10px;z-index:500;display:flex;flex-direction:row;gap:4px}
#layerBtns button{width:36px;height:36px;border-radius:50%;background:var(--bg2);border:1px solid var(--brd);font-size:16px;cursor:pointer;box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;transition:.2s;padding:0;line-height:1}
#layerBtns button:hover{border-color:var(--ac);background:#eff6ff}
#layerBtns button.on{background:#2563eb;border-color:#2563eb;box-shadow:0 0 8px rgba(37,99,235,.3)}
/* Dashboard styles */
.dash-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-bottom:10px}
.dash-card{background:var(--card);border:1px solid var(--brd);border-radius:8px;padding:10px;text-align:center;box-shadow:var(--shadow)}
.dash-val{font-size:22px;font-weight:800;color:var(--ac)}
.dash-label{font-size:10px;color:var(--tx2);margin-top:2px}
.dash-section{background:var(--card);border:1px solid var(--brd);border-radius:8px;padding:10px;margin-bottom:8px;font-size:12px;box-shadow:var(--shadow)}
.dash-section b{display:block;margin-bottom:6px}
.dash-timeline{display:flex;align-items:flex-end;gap:2px;height:55px;padding:4px 0}
.dash-bar{width:100%;min-width:4px;border-radius:2px 2px 0 0;transition:.3s}
.dash-table{width:100%;border-collapse:collapse;font-size:11px}
.dash-table th{text-align:right;padding:4px 6px;border-bottom:1px solid var(--brd);color:var(--tx2);font-weight:600}
.dash-table td{padding:4px 6px;border-bottom:1px solid rgba(0,0,0,.04)}
.dash-info{font-size:11px;color:var(--tx2);padding:2px 0}
.dash-btn{padding:4px 10px;font-size:11px;border:1px solid var(--brd);border-radius:6px;background:var(--card);cursor:pointer;font-family:inherit;transition:.2s}
.dash-btn:hover{border-color:var(--ac);background:#eff6ff}
/* Wadi flood zone lines */
.wadi-line{stroke-linecap:round}
/* Dark mode additions */
body.dark #layerBtns button{background:#1f2937;border-color:#374151}
body.dark #layerBtns button:hover{background:#374151}
body.dark #layerBtns button.on{background:#2563eb;border-color:#2563eb}
body.dark .dash-card{background:#1f2937;border-color:#374151}
body.dark .dash-section{background:#1f2937;border-color:#374151}
body.dark .dash-btn{background:#1f2937;border-color:#374151;color:#9ca3af}
@media(prefers-color-scheme:dark){
  #layerBtns button{background:#1f2937;border-color:#374151}
  #layerBtns button.on{background:#2563eb;border-color:#2563eb}
  .dash-card{background:#1f2937;border-color:#374151}
  .dash-section{background:#1f2937;border-color:#374151}
  .dash-btn{background:#1f2937;border-color:#374151;color:#9ca3af}
}
</style>
</head>
<body>

<header id="header">
  <div class="brand">ğŸŒ§ï¸ <strong>Flood<span>Guard</span> IL</strong></div>
  <div class="status"><div class="pulse-dot"></div><span id="statusMsg">××¢×¨×›×ª ×¤×¢×™×œ×”</span><span id="clock"></span><button onclick="toggleSound()" id="btnSound" style="background:none;border:none;font-size:16px;cursor:pointer;margin-right:4px" title="×”×©×ª×§/×”×¤×¢×œ ×¦×œ×™×œ×™×">ğŸ””</button><button onclick="toggleDarkMode()" id="btnDark" style="background:none;border:none;font-size:16px;cursor:pointer;margin-right:6px" title="××¦×‘ ×œ×™×œ×”/×™×•×">ğŸŒ™</button></div>
</header>

<div id="app">
  <div id="mapWrap">
    <div id="map"></div>

    <div id="mapBtns">
      <button onclick="toggleSrc('ims')" id="btnIms">ğŸ“¡ ×©×"×˜</button>
      <button onclick="toggleSrc('rainviewer')" id="btnWindy">ğŸŒ§ï¸ RainViewer</button>
      <button onclick="analyze()" id="btnRun">âš¡ × ×ª×—</button>
      <button onclick="toggleAuto()" id="btnAuto">ğŸ”„ ××•×˜×•××˜×™</button>
      <button onclick="locateMe()" id="btnLocate" title="××¦× ××ª ×”××™×§×•× ×©×œ×™">ğŸ“</button>
      <button onclick="refreshRadar()" id="btnRefresh" style="display:none">ğŸ”ƒ ×¨×¢× ×Ÿ</button>
    </div>
    <!-- Map layer controls -->
    <div id="layerBtns">
      <button onclick="toggleLayer('wadis')" id="btn_wadis" title="× ×—×œ×™× ××•×¢×“×™× ×œ×”×¦×¤×•×ª">ğŸŒŠ</button>
      <button onclick="toggleLayer('floods')" id="btn_floods" title="××–×•×¨×™ ×”×¦×¤×”">âš ï¸</button>
      <button onclick="toggleLayer('topo')" id="btn_topo" title="×˜×•×¤×•×’×¨×¤×™×”">ğŸ”ï¸</button>
      <button onclick="toggleLayer('satellite')" id="btn_satellite" title="×œ×•×•×™×™×Ÿ">ğŸ›°ï¸</button>
    </div>
    <div id="legend">
      <b>××§×¨×</b>
      <div><span class="dot" style="background:#9ca3af"></span> ×ª×§×™×Ÿ</div>
      <div><span class="dot" style="background:#f59e0b"></span> 15-25 ×"×/×©×¢×”</div>
      <div><span class="dot" style="background:#ef4444"></span> 25-40 ×"×/×©×¢×”</div>
      <div><span class="dot" style="background:#dc2626;box-shadow:0 0 6px #dc2626"></span> 40+ ×"×/×©×¢×”</div>
    </div>
    <div id="radarTime" style="display:none;position:absolute;top:50px;right:10px;z-index:500;background:var(--card);border:1px solid var(--brd);border-radius:8px;padding:6px 10px;font-size:11px;color:var(--tx2);">
      ğŸ• ××›"×: <span id="radarTimeVal">--</span>
    </div>
    <div id="forecastInfo" style="display:none;position:absolute;bottom:40px;left:10px;z-index:500;background:var(--card);border:1px solid var(--brd);border-radius:8px;padding:8px 12px;font-size:11px;color:var(--tx2);max-width:260px;">
      <span id="forecastText"></span>
    </div>
    <!-- Radar animation bar -->
    <div id="animBar">
      <button onclick="animPrev()" title="×”×§×•×“×">â®</button>
      <button onclick="animToggle()" id="animPlayBtn" title="× ×’×Ÿ/×¢×¦×•×¨">â–¶ï¸</button>
      <button onclick="animNext()" title="×”×‘×">â­</button>
      <input type="range" id="animSlider" min="0" max="0" value="0" oninput="animSeek(this.value)">
      <span id="animTime">--:--</span>
      <button onclick="animClose()" title="×¡×’×•×¨">âœ–</button>
    </div>
  </div>

  <div id="sidebar">
    <div id="tabs">
      <button class="tab on" onclick="showTab('alerts',this)">ğŸ”” ×”×ª×¨××•×ª</button>
      <button class="tab" onclick="showTab('list',this)">ğŸ˜ï¸ ×™×™×©×•×‘×™×</button>
      <button class="tab" onclick="showTab('dashboard',this)">ğŸ“Š ×œ×•×—</button>
      <button class="tab" onclick="showTab('forecast',this)">ğŸ”® ×ª×—×–×™×ª</button>
      <button class="tab" onclick="showTab('upload',this)">ğŸ“¤ ×”×¢×œ××”</button>
    </div>
    <div id="panel">
      <div id="p-alerts" class="pane on">
        <div id="counters">
          <div class="cnt cw"><div id="cntM" class="cnt-n">0</div><div class="cnt-l">×‘×™× ×•× ×™</div></div>
          <div class="cnt cd"><div id="cntH" class="cnt-n">0</div><div class="cnt-l">×—×–×§</div></div>
          <div class="cnt ce"><div id="cntE" class="cnt-n">0</div><div class="cnt-l">×›×‘×“ ×××•×“</div></div>
        </div>
        <div id="notifBanner" style="display:none;background:rgba(37,99,235,.08);border:1px solid rgba(37,99,235,.2);border-radius:8px;padding:10px;margin-bottom:8px;font-size:12px;">
          ğŸ”” ×¨×•×¦×” ×œ×§×‘×œ ×”×ª×¨××•×ª ×’× ×›×©×”××¤×œ×™×§×¦×™×” ×¡×’×•×¨×”?
          <button onclick="requestNotifPermission()" style="display:block;margin-top:6px;width:100%;padding:8px;background:#2563eb;color:#fff;border:none;border-radius:6px;font-weight:bold;cursor:pointer">××©×¨ ×”×ª×¨××•×ª</button>
        </div>
        <div id="alertCards">
          <p class="hint">×œ×—×¥ "âš¡ × ×ª×—" ×œ×”×¤×¢×œ×ª × ×™×ª×•×— ××›"×</p>
        </div>
      </div>
      <div id="p-list" class="pane">
        <input type="text" id="search" placeholder="ğŸ” ×—×¤×© ×™×™×©×•×‘..." oninput="filterList()">
        <div id="settCards"></div>
      </div>
      <div id="p-dashboard" class="pane">
        <div id="dashPanel">
          <p class="hint">ğŸ“Š ×œ×•×— ×”×‘×§×¨×” ×™×ª××œ× ××—×¨×™ × ×™×ª×•×— ×¨××©×•×Ÿ<br>×œ×—×¥ "âš¡ × ×ª×—" ×œ×”×ª×—×œ×”</p>
        </div>
      </div>
      <div id="p-forecast" class="pane">
        <div style="padding:4px 0">
          <b>ğŸ”® ×ª×—×–×™×ª ×ª× ×•×¢×ª ×’×©×</b>
          <p style="font-size:11px;color:var(--tx2);margin:4px 0">××‘×•×¡×¡ ×¢×œ × ×™×ª×•×— ×›×™×•×•×Ÿ ×•××”×™×¨×•×ª ×ª× ×•×¢×ª ×”×’×©×</p>
        </div>
        <div id="forecastStatus" style="font-size:12px;padding:8px;background:rgba(0,0,0,.03);border-radius:6px;margin-bottom:8px;">
          â³ ×œ×—×¥ RainViewer ×•××– "ğŸ”„ ××•×˜×•××˜×™" â€” ×”××¢×¨×›×ª ×¦×•×‘×¨×ª ×¤×¨×™×™××™× ×•××™×™×¦×¨×ª ×ª×—×–×™×ª
        </div>
        <div id="forecastCards"></div>
      </div>
      <div id="p-upload" class="pane">
        <p class="hint">×”×¢×œ×” ×ª××•× ×ª ××›"× ×’×©× ×œ× ×™×ª×•×— ×™×“× ×™</p>
        <p style="font-size:11px;color:var(--tx2);margin:0 0 8px">×‘×—×¨ ××§×•×¨ ×•×¡×§×œ×ª ×¦×‘×¢×™×:</p>
        <div style="display:flex;gap:6px;margin-bottom:4px;">
          <button onclick="setUploadSrc('ims')" class="srcBtn on" id="srcIms">×©×"×˜</button>
          <button onclick="setUploadSrc('govmap')" class="srcBtn" id="srcGov">GovMap</button>
          <button onclick="setUploadSrc('rainviewer')" class="srcBtn" id="srcRv">RainViewer</button>
        </div>
        <div id="srcUnits" style="font-size:10px;color:var(--tx2);margin-bottom:8px;padding:4px 6px;background:rgba(0,0,0,.03);border-radius:4px;">ğŸ“ ×©×"×˜: ×"×/×©×¢×” (mm/hr) â€” ×œ×œ× ×”××¨×”</div>
        <div id="dropZone" onclick="document.getElementById('fileIn').click()">
          ğŸ“¤ ×œ×—×¥ ×œ×”×¢×œ××ª ×ª××•× ×”
        </div>
        <input type="file" id="fileIn" accept="image/*" style="display:none" onchange="onUpload(event)">
        <canvas id="cvs" style="display:none"></canvas>
        <div id="uploadRes"></div>
      </div>
    </div>
  </div>
</div>


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="app_p1.js"></script>
<script src="app_p2.js"></script>
<script src="app_p3.js"></script>
<script src="app_p4.js"></script>
</body>
</html>
